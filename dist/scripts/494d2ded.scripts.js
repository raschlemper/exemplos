"use strict";function chooseMenu(a){for(var b=angular.element("#menu").children(),c=0;c<b.length;c++){var d=angular.element(b[c]),e=angular.element(d).children(),f=angular.element(e).attr("href").replace("#","");a===f?angular.element(d).addClass("active"):angular.element(d).removeClass("active")}}var app=angular.module("exemplosApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngLocale","ui.bootstrap","blockUI","ngToast"]);app.config(["$routeProvider","$locationProvider","$httpProvider","blockUIConfig",function(a,b,c,d){d.message="Carregando...",d.delay=100,a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/configuration",{templateUrl:"views/configuration.html",controller:"ConfigurationCtrl"}).when("/report/new",{templateUrl:"views/report.html",controller:"ReportCtrl"}).when("/report",{templateUrl:"views/report/report.html",controller:"ReportNewCtrl"}).when("/preview",{templateUrl:"views/preview.html",controller:"PreviewCtrl"}).otherwise({redirectTo:"/"}),c.interceptors.push("menuInterceptor")}]).factory("menuInterceptor",["$location",function(a){return{request:function(b){b.headers=b.headers||{};var c=a.path();return chooseMenu(c),b}}}]),app.controller("ConfigurationCtrl",["$scope","$filter","$location","$routeParams","$window","TemplateService","JsonService","VisioService","EntityService","MessageService",function(a,b,c,d,e,f,g,h,i,j){a.visio={},a.templates=[],a.campos=[],a.selection={},a.component={},a.totalItens=0,a.selectedsFiltered=[],a.groups=[],a.formats=[],a.form={},a.edit=!1,a.agrupador={};var k=function(){a.component.data&&a.component.data.fields.length&&(a.totalItens=a.component.data.fields.length)};a.selectComponent=function(b){a.selectedComponent=b},a.totalPorPagina=4,a.paginaAtual=1,a.mudaPagina=function(b){a.paginaAtual=b,p()},a.editComponent=function(b){a.component=b,("table"===b.type||"list"===b.type)&&(a.component.data?a.selectedsFiltered=[]:(a.component.data={fields:[],format:{type:"list"}},a.selectedsFiltered=[])),o()},a.selectTemplate=function(){a.visio.layout=a.selection.template,a.visio.layout.templateId=a.selection.template._id,l()};var l=function(){a.component={},a.selectedComponent={}};a.saveFields=function(){for(var b=0;b<a.visio.layout.containers.length;b++)for(var c=0;c<a.visio.layout.containers[b].components.length;c++)a.visio.layout.containers[b].components[c]._id===a.component._id&&a.visio.layout.containers[b].components[c].data.fields===a.component.data.fields;j.success("Campos salvos com sucesso!")};var m=function(){d.hashid?h.service.getByHashid(d.hashid).then(function(b){a.visio=b[0],n()})["catch"](function(a){return j.danger("Erro ao recuperar visão: "+a),console.log(a)}):(a.visio.campos=[],a.visio.layout={},n())},n=function(){f.service.getAll().then(function(b){if(a.templates=b,d.hashid){var c=a.templates.filter(function(b){return b._id==a.visio.layout.templateId});a.selection.template=c[0]}else a.selection.template=b[0],a.visio.layout=b[0],a.visio.layout.templateId=b[0]._id})["catch"](function(a){return j.danger("Erro ao recuperar templates: "+a),console.log(a)})};a.menus=[{ordem:1,titulo:"Visão"},{ordem:2,titulo:"Template"},{ordem:3,titulo:"Campos"},{ordem:4,titulo:"Resumo"}],a.makePreview=function(){f.service.setOptionPreview(a.visio.layout),c.path("/preview")},a.isValid=function(a){return a===!0?a:!1};var o=function(){i.entity().then(function(b){var c=b;a.component.data&&c.filter(function(b){if(a.component.data.fields.length){for(var c=0;c<a.component.data.fields.length;c++)b._id===a.component.data.fields[c]._id&&(a.component.data.fields[c].selected=!0,b.selected=!0);a.selectedsFiltered=a.component.data.fields}}),a.campos=c})["catch"](function(a){return console.log(a)})};a.addCampo=function(b){b.selected?(b.selected=!1,a.component.data.fields=_.without(a.component.data.fields,_.findWhere(a.component.data.fields,{_id:b._id}))):(b.selected=!0,a.component.data.fields.push(b)),a.selectedsFiltered=a.component.data.fields,k(),p()},a.removeCampo=function(b){b.selected=!1,a.component.data.fields=_.without(a.component.data.fields,_.findWhere(a.component.data.fields,{_id:b._id})),a.component.data.formulas&&r(b),a.selectedsFiltered=a.component.data.fields,k(),p()},a.message=function(a){j.success(a)},a.saveVisio=function(){d.hashid?h.service.update(a.visio):(a.visio.createDate=new Date,a.visio.hashid=Math.floor(1e10+9e10*Math.random()),h.service.addVisio(a.visio)),j.success("Visão salva com sucesso!"),c.path("/main")};var p=function(){var c=a.paginaAtual-1;a.selectedsFiltered=b("startPage")(a.component.data.fields,c*a.totalPorPagina)};a.tab=1,a.addFieldGroup=function(b){if(a.groups.length){var c=_.findWhere(a.groups,{_id:b._id});c||a.groups.push(b)}else b&&a.groups.push(b)},a.addFieldFormat=function(b){if(a.formats.length){var c=_.findWhere(a.formats,{_id:b._id});c||a.formats.push(b)}else b&&a.formats.push(b)},a.removeFieldGroup=function(b){a.groups=_.without(a.groups,_.findWhere(a.groups,{_id:b._id}))},a.removeFieldFormat=function(b){a.formats=_.without(a.formats,_.findWhere(a.formats,{_id:b._id}))},a.createGrouper=function(b){if(a.component.data.formulas||(a.component.data.formulas=[]),a.edit){for(var c=a.component.data.formulas.length-1;c>=0;c--)if(a.component.data.formulas[c].alias===a.agrupador.alias){var d=q(a.agrupador.name,!1,!0,"number");d.description=a.agrupador.description,a.agrupador.field=d,a.agrupador.group=b,a.component.data.formulas[c]=a.agrupador;break}}else{a.agrupador.alias="cd_totalizer_"+Math.floor(1e10+9e10*Math.random());var d=q(a.agrupador.name,!1,!0,"number");d.description=a.agrupador.description,a.agrupador.field=d,a.agrupador.group=b,a.component.data.formulas.push(a.agrupador)}a.groups=[],a.edit=!1,a.agrupador={},a.setTab(1)},a.createFormat=function(b){a.component.data.format||(a.component.data.format={}),a.editFormat?a.format=a.component.data.format:(a.component.data.format.type=b.type,a.component.data.format.fieldName=q(b.fieldName.key.label,!0,!1,"text"),a.component.data.format.fieldValue=q(b.fieldValue.key.label,!1,!0,"number"),a.component.data.format.fields=a.formats),a.formats=[],a.editFormat=!1,a.format={},a.setTab(3)};var q=function(a,b,c,d){var e={},f=Math.floor(1e10+9e10*Math.random());return e.key={isKey:!1,type:d,label:a},e.value={isKey:!1,type:d,label:a},c&&(e.key.filter=["currency","R$ "],e.value.filter=["currency","R$ "]),b?(e.key.field="cd_format_key_"+f,e.value.field="cd_format_key_"+f):(e.key.field="cd_format_value_"+f,e.value.field="cd_format_value_"+f),e.expression="<%= "+e.key.field+" %>",e.name=a,e.selected=!0,e};a.updateTotalizer=function(b){a.agrupador=b,a.groups=b.group,a.edit=!0,a.setTab(2)},a.updateFormat=function(b){a.format=b,a.formats=b.fields,a.editFormat=!0,a.setTab(4)},a.setTab=function(b){a.tab=b},a.isSet=function(b){return a.tab===b},a.removeTotalizer=function(b){a.component.data.formulas=_.without(a.component.data.formulas,_.findWhere(a.component.data.formulas,{alias:b.alias}))},a.removeFormatter=function(){a.component.data.format={}};var r=function(b){if(a.component.data.formulas.length)for(var c=a.component.data.formulas.length-1;c>=0;c--){var d=a.component.data.formulas[c].groups;d=_.without(d,_.findWhere(d,{_id:b._id})),a.component.data.formulas[c].groups=d}},s=function(){m()};s()}]),app.controller("MainCtrl",["$scope","$location","$filter","VisioService","MessageService",function(a,b,c,d,e){a.visios=[],a.totalItens=0,a.totalPorPagina=6,a.paginaAtual=1,a.filtered=[],a.setVisio=function(b){a.visio=b},a.mudaPagina=function(b){a.paginaAtual=b,g()},a.newVisio=function(){b.path("/configuration")},a.viewReport=function(a){b.url("/report").search("hashid",a.hashid)},a.updateVisio=function(a){b.url("/configuration").search("hashid",a.hashid)};var f=function(){d.service.getAll().then(function(b){a.visios=b,a.totalItens=b.length,g()})["catch"](function(a){return e.danger("Erro ao carregar visões: "+a),console.log(a)})};a.removeVisio=function(){a.visio&&d.service.remove(a.visio),a.visio={},f()};var g=(function(){f()}(),function(){var b=a.paginaAtual-1;a.filtered=c("startPage")(a.visios,b*a.totalPorPagina)})}]),app.controller("PreviewCtrl",["$scope","TemplateService","$location","$routeParams",function(a,b,c,d){a.option={},a.visio={},a.visio.layout=b.service.getOptionPreview(),a.columns=[1,2,3,4,5,6,7,8,9,10,11,12],a.backConfiguration=function(){c.url("/configuration").search("hashid",d.hashid)},a.dadosteste={status:"R",aluno:"Nome do Aluno",vencimento:"08/05/2015",pagamento:"08/05/2015",valor:"100,00"}}]),app.controller("FooterCtrl",["$scope","VERSION",function(a,b){a.version=b,a.footer="Portal Financeiro-"+a.version+"  by Gennera"}]),app.controller("ReportNewCtrl",["$scope","$routeParams","ReportNewService","MovimentoService","VisioService","JsonService","MessageService",function(a,b,c,d,e,f,g){var h=0,i=[],j={};a.link=[],a.page=[],a.visio={};var k=function(){l()},l=function(){d.movimento().then(function(a){i=a,m()})["catch"](function(a){g.danger("Erro ao recuperar dados do relatório: "+a),data=[]})},m=function(){e.service.getByHashid(b.hashid).then(function(b){j=b[0],a.getLinks()})["catch"](function(a){g.danger("Erro ao criar relatório: "+a),layout=[]})};a.getLinks=function(){a.link=c.links(i,j),a.getLink(a.link.selected[0],h)},a.getLink=function(b,d){a.link=c.link(b,d);var e=angular.copy(a.link.selected);a.getPages(e,a.link.links[0])},a.getPages=function(b,d){var e=(angular.copy(b),d.key);_.map(b,function(a,c){c+1<b.length&&_.extend(e,a)}),a.page=c.pages(i,j,e),a.getPage(a.page.pages)},a.getPage=function(b){a.visio=c.page(angular.copy(j),b),console.log(a.visio)},k()}]),app.directive("layout",["$compile","$sce",function(a,b){return{restrict:"E",transclude:!0,replace:!0,templateUrl:"scripts/directives/layout/html/layout.template.html",scope:{configuracao:"=",preview:"=",minHeight:"=",blocks:"="},link:function(a){a.getHeight=function(){return a.minHeight?"min-height:"+a.minHeight+"px;":void 0},a.previewStyle=function(){return a.preview?"layout layout-border":void 0}}}}]),app.directive("treeView",["DataGrouperService",function(a){return{restrict:"A",scope:{groups:"=",data:"="},link:function(b,c,d,e){var f=[],g=function(a,b){if(0!=a.length){var c=h(a,b,null),d=_.groupBy(c,b[0]);_.property(b[0])(c),_.groupBy(d[0],"ds_tipo_curso");console.log(d)}},h=function(b,c,d){var e=i(c,d);if(c&&b){var f=a.report(b,e);return _.map(f,function(a){return a.key})}},i=function(a,b){var c=[];return(b||null==b)&&(b=a.length),_.map(a,function(a,d){b>=d&&c.push(a)}),c};b.$watch("data",function(a,d){g(b.data,b.groups),c.css("padding","0"),c.treeview({data:f,showBorder:!1})})}}}]),app.directive("block",[function(){return{restrict:"AE",transclude:!0,replace:!0,templateUrl:"scripts/directives/ui-blocks/block.template.html",scope:{columns:"=",offsetRow:"=",lines:"=",group:"=",offsetLine:"=",lineHeight:"=",component:"=",previewBlock:"=",verticalAlign:"="},link:function(a,b,c,d){a.getColumn=function(){return"col-md-"+a.columns},a.getRowOffset=function(){return a.offsetRow?"col-md-offset-"+a.offsetRow:void 0},a.getLineOffset=function(){return a.offsetLine?"margin-top:"+a.offsetLine*a.lineHeight+"px;":void 0},a.getHeight=function(){return a.lines?"height:"+a.lines*a.lineHeight+"px;":"height: 100%;"},a.isGroup=function(){return a.group?"display: inline-group;":void 0},a.isVerticalAlign=function(){return a.verticalAlign?"vertical-align":void 0},a.previewPadding=function(){return a.previewBlock?"padding: 0px;":void 0}}}}]),app.directive("step",function(){return{templateUrl:"scripts/directives/wizard/views/stepTemplate.html",restrict:"E",replace:!0,transclude:!0,require:["^wizard"],scope:{ordem:"=",title:"=",minHeight:"="},link:function(a,b,c,d){a.wizardCtrl=d[0],a.mostraAtual=function(){return a.wizardCtrl.mostraAtual()},a.isActive=function(){return a.ordem===a.mostraAtual()?!0:void 0},a.getMinHeight=function(){return a.minHeight?"min-height:"+a.minHeight+"px;":void 0}}}}),app.directive("wizard",function(){return{templateUrl:"scripts/directives/wizard/views/wizardTemplate.html",restrict:"E",transclude:!0,controllerAs:"wizard",scope:{configuracao:"=",steps:"=",valid:"="},controller:["$scope",function(a){a.atual=1,a.finished=[],a.proximo=function(){a.atual<a.steps&&(a.finished.push(a.atual),a.atual=a.atual+1)},a.isCompleted=function(b){return b<a.atual?!0:!1},a.anterior=function(){if(a.atual<=a.steps){var b=a.finished.indexOf(a.atual);a.finished.splice(b),a.atual=a.atual-1}},a.updateAtual=function(b){if(a.isCompleted(b)){for(var c=[],d=1;b>d;d++)c.push(d),a.finished=c;a.finished=c,a.isAtual(b)||(a.atual=b)}},a.isAtual=function(b){return b===a.atual?!0:!1},this.isAtualGlobal=function(b){return b==a.atual?!0:void 0},this.mostraAtual=function(){return a.atual}}]}}),app.directive("widget",[function(){return{restrict:"E",replace:!0,templateUrl:"scripts/directives/widget/widget.template.html",scope:{data:"=",type:"="},link:function(a,b,c,d){var e=function(){"table"===a.type&&(a.table=!0)},f=function(){"text"===a.type&&(a.text=!0,0===Object.keys(a.data[0]).length&&(a.data[0]=""))},g=function(){"image"===a.type&&(a.image=!0)},h=function(){"title"===a.type&&(a.title=!0)},i=function(){"list"===a.type&&(a.list=!0)};e(),f(),g(),h(),i()}}}]),app.directive("breadcrumbs",[function(){return{restrict:"E",templateUrl:"scripts/directives/breadcrumbs/breadcrumbs.html",scope:{data:"="},link:function(a,b,c,d){a.lists=[],a.$watch("data",function(a,b){a!=b&&(g(),e())});var e=function(){a.lists=[];var b=[];_.map(a.values,function(c,d){b=0==d?f(a.data,c,d):f(b,c,d)})},f=function(b,c,d){var e=_.pluck(b,"item"),f=e[c];return a.lists.push({id:d,itens:e,selected:f}),b[c].values};a.setValue=function(b,c){a.values[c]=b,e()};var g=function(){a.values||(a.values=[],h(a.data[0]))},h=function(b){var c=b.values;c&&(a.values.push(0),h(c[0]))}}}}]),app.filter("startPage",function(){return function(a,b){if(angular.isArray(a)){var c=parseInt(b,10);return isNaN(c)&&(c=0),a.slice(c)}return a}}),app.constant("ENV","dev").constant("VERSION","0.0.1-BETA").constant("SERVER","10.0.1.127:9000"),app.factory("CampoService",["$http","$q",function(a,b){return{campo:function(c){var d=c||angular.noop,e=b.defer();return a.get("/financeiro/campo").success(function(a){return e.resolve(a),d()}).error(function(a){return e.reject(a),d(a)}.bind(this)),e.promise}}}]),app.factory("JsonService",["$http","$q",function(a,b){return{movimento:function(c){var d=c||angular.noop,e=b.defer();return a.get("data/movimento.json").success(function(a){return e.resolve(a),d(a)}).error(function(a){return e.reject(a),d(a)}.bind(this)),e.promise},visioTest:function(c){var d=c||angular.noop,e=b.defer();return a.get("data/test/visio.json").success(function(a){return e.resolve(a),d(a)}).error(function(a){return e.reject(a),d(a)}.bind(this)),e.promise},visioLineTest:function(c){var d=c||angular.noop,e=b.defer();return a.get("data/test/visio_line.json").success(function(a){return e.resolve(a),d(a)}).error(function(a){return e.reject(a),d(a)}.bind(this)),e.promise},layoutTest:function(c){var d=c||angular.noop,e=b.defer();return a.get("data/test/layout.json").success(function(a){return e.resolve(a),d(a)}).error(function(a){return e.reject(a),d(a)}.bind(this)),e.promise},camposTest:function(c){var d=c||angular.noop,e=b.defer();return a.get("data/test/campos.json").success(function(a){return e.resolve(a),d(a)}).error(function(a){return e.reject(a),d(a)}.bind(this)),e.promise},campos:function(c){var d=c||angular.noop,e=b.defer();return a.get("data/campos_movimento.json").success(function(a){return e.resolve(a),d(a)}).error(function(a){return e.reject(a),d(a)}.bind(this)),e.promise}}}]),app.factory("TemplateService",["$http","$q",function(a,b){var c={},d={},e={};return e.getOptionPreview=function(){return c},e.setOptionPreview=function(a){c=a},e.getConfiguration=function(){return d},e.setConfiguration=function(a){d=a},e.getAll=function(c){var d=c||angular.noop,e=b.defer();return a.get("/financeiro/template").success(function(a){return e.resolve(a),d()}).error(function(a){return e.reject(a),d(a)}.bind(this)),e.promise},e.getById=function(c,d){var e=d||angular.noop,f=b.defer();return a.get("/financeiro/template/"+c,{params:{id:c}}).success(function(a){return f.resolve(a),e()}).error(function(a){return f.reject(a),e(a)}.bind(this)),f.promise},{service:e}}]),app.factory("MovimentoService",["$http","$q",function(a,b){return{movimento:function(c){var d=c||angular.noop,e=b.defer();return a.get("/financeiro/movimento").success(function(a){return e.resolve(a),d()}).error(function(a){return e.reject(a),d(a)}.bind(this)),e.promise},movimentoByHeader:function(c,d){var e=d||angular.noop,f=b.defer();return a.post("/financeiro/movimento/field/header",{fields:c}).success(function(a){return f.resolve(a),e()}).error(function(a){return f.reject(a),e(a)}.bind(this)),f.promise}}}]),app.factory("VisioService",["$http","$q","SERVER",function(a,b,c){var d={};return d.addVisio=function(c,d){var e=d||angular.noop,f=b.defer();a.post("/financeiro/visio",c).success(function(a){return f.resolve(a),e()}).error(function(a){return f.reject(a),e(a)}.bind(this))},d.remove=function(c,d){var e=b.defer();a.post("/financeiro/visio/remove",c).error(function(a){return e.reject(a),cb(a)}.bind(this))},d.update=function(c,d){var e=b.defer();a.put("/financeiro/visio",c).error(function(a){return e.reject(a),cb(a)}.bind(this))},d.getAll=function(c){var d=c||angular.noop,e=b.defer();return a.get("/financeiro/visio").success(function(a){return e.resolve(a),d()}).error(function(a){return e.reject(a),d(a)}.bind(this)),e.promise},d.getByHashid=function(c,d){var e=d||angular.noop,f=b.defer();return a.get("/financeiro/visio/"+c,{}).success(function(a){return f.resolve(a),e()}).error(function(a){return f.reject(a),e(a)}.bind(this)),f.promise},{service:d}}]),app.factory("BlockService",["blockUI","blockUIConfig","$timeout",function(a,b,c){return{block:function(b){a.start(b)},stop:function(b){b?c(function(){a.stop()},b):a.stop()}}}]),app.factory("EntityService",["$http","$q",function(a,b){return{entity:function(c){var d=c||angular.noop,e=b.defer();return a.get("/financeiro/entity").success(function(a){return e.resolve(a),d()}).error(function(a){return e.reject(a),d(a)}.bind(this)),e.promise},create:function(c,d){var e=d||angular.noop,f=b.defer();a.post("/financeiro/entity",c).success(function(a){return f.resolve(a),e()}).error(function(a){return f.reject(a),e(a)}.bind(this))}}}]),app.factory("ReportNewService",["ComponentService","LinkService","PageService",function(a,b,c){var d={selected:[],values:[],lists:[],links:[]},e={};e.orderBy=function(a){return _.sortBy(a,function(a){return a.order})},e.createComponents=function(a){var b=[];return _.map(a.components,function(c){c.data||(c.data={}),b.push({containerType:a.type,code:c._id,type:c.type,data:c.data})}),b},e.getComponents=function(a){var b=[];return _.map(a.containers,function(a){var c=e.createComponents(a);b=_.union(b,c)}),b},e.getReportFilter=function(a){var b=e.getComponents(a),c=_.where(b,{containerType:"header"}),d=_.reduce(c,function(a,b){return b.data?_.union(a,b.data.fields):void 0},[]);return e.orderBy(d)};var f=function(a){var b=_.pluck(a,"value"),c=_.pluck(a,"key");return _.map(c,function(a,c){var d=_.pluck(b[c],"field"),e=_.pluck(a,"field");return _.union(d,e)},[])},d=function(a,c){return b.link(a,c)},g=function(a,c){var d=e.getReportFilter(c.layout),g=f(d);return b.links(a,d,g)},h=function(b,c){return _.map(b,function(b){b.components=_.map(b.components,function(b){return a.create(c,b)})}),b},i=function(a,b){return a.layout.containers=h(a.layout.containers,b),a},j=function(a,b,d){return c.pages(d,a)};return{links:g,link:d,pages:j,page:i}}]),app.factory("ComponentService",["DataGrouperService","PageService","FormatService","ConvertService","FormulaService",function(a,b,c,d,e){var f=function(a){var b=[];return _.map(a,function(a){b=_.union(b,_.pluck(a,"field"))}),b},g=function(a){var b=[];return b.push(a),b},h=function(a){return a.data.fields||a.data.groups?void 0:(a.data=g(a.data),a)},i=function(a,b){return _.map(b,function(b){return d.formatField(a,b)})},j=function(a){var b=[],c=_.where(a.data.fields,{selected:!0});return _.map(a.data.registers,function(a){b.push(i(a,c))}),a.data=b,a},k=function(a){return a.data.fields?(a.data=e.calculate(a.data),a):a},l=function(a,b){return b.data.fields?(b.data=c.apply(a,b.data),b):b},m=function(b,c){if(!c.data.fields)return b;var d=f(_.pluck(c.data.fields,"key")),e=f(_.pluck(c.data.fields,"value"));return a.group(b,_.union(d,e))},n=function(a,b){var c=m(a,b);return b=l(c,b),b=k(b),b=j(b)},o=function(a,b){return b.data?b.data.fields?n(a,b):h(b):void 0},p=function(a,b){return o(a,b)};return{create:p}}]),app.factory("LinkService",["DataGrouperService","ConvertService",function(a,b){var c={selected:[],values:[],lists:[],links:[]},d=function(){c.lists=[],c.links=[];var a=c.values;_.map(c.selected,function(b,d){d+1<c.selected.length&&(a=f(a,b,d))})},e=function(){var a=c.values;_.map(c.selected,function(b,d){var e=j(a,b);d+1==c.selected.length?g(a):a=a[e].values})},f=function(a,b,d){var e=j(a,b);return c.lists.push({id:d,itens:_.pluck(a,"item"),selected:a[e].item}),a[e].values},g=function(a){var b=_.pluck(a,"item");c.links=b},h=function(a,b,d){if(a){var e=j(a,c.selected[b]),f=a[e];if(i(f,b,d),!f.values)return;h(f.values,b+1,d)}},i=function(a,b,d){0==b?c.selected[b]=a.item.key:c.selected[b]?b>d&&(c.selected[b]=a.item.key):c.selected.push(a.item.key)},j=function(a,b){var c=_.pluck(a,"item"),d=_.pluck(c,"key"),e=_.indexOf(d,b);return 0>e?0:e},k=function(a,c,d){return d!=c.length?_.map(a,function(a,e){var f=k(a.vals,c,d+1),g={item:b.formatField(a.key,c[d])};return f&&_.extend(g,{values:f}),g}):void 0},l=function(a){return h(c.values,0,a),d(),e(),c},m=function(a,b){return c.selected[b]=a,l(b)},n=function(b,d,e){var f=a.hierarchy(b,e);return c.values=k(f,d,0),c};return{links:n,link:m}}]),app.factory("PageService",["DataGrouperService",function(a){var b={values:[],pages:[],page:{}},c=function(){b.pages=angular.copy(b.values)},d=function(a,b){return a?_.where(b,a):b},e=function(a){return b.page=a,b},f=function(a,e){var f=d(a,e);return b.values=f,c(),b};return{pages:f,page:e}}]),app.factory("FormatService",["DataGrouperService",function(a){var b=function(a){var b=a.fields;return a.format.fieldName&&b.push(a.format.fieldName),a.format.fieldValue&&b.push(a.format.fieldValue),b},c=function(a){var b=[],c=a.value;return _.map(c,function(a){b.push(a.field)}),b},d=function(a,b,c){var d=[];return d.push(a),d},e=function(a,b,d){var e=[],f=d.fieldName.key.field,g=d.fieldValue.key.field;return _.map(d.fields,function(d){var h=c(d),i=_.map(h,function(c){var e=_.pick(b,c),h=angular.copy(a);return h[f]=d.name,h[g]=_.property(c)(e),h});e=_.union(e,i)}),e},f=function(a,b,d){var e=[],f=angular.copy(a);return _.map(d.fields,function(a){var d=c(a);_.map(d,function(a){var c=_.pick(b,a);_.extend(f,c)})}),e.push(f),e},g=function(a,b,c){if(b){var d=[];return _.map(a,function(a){var e=a.key;_.map(a.vals,function(a){var f=c(e,a,b);d=_.union(d,f)})}),d}},h=function(a){switch(a){case"column":return e;case"line":return f;default:return d}},i=function(a,c){var d=h(c.format.type);return c.fields=b(c),c.registers=g(a,c.format,d),c};return{apply:i}}]),app.factory("FormulaService",["DataGrouperService",function(a){var b=function(a){var b=a.fields;return a.formulas?(_.map(a.formulas,function(a){b.push(a.field)}),b):b},c=function(a,b,c){var d=f(a,b);return _.reduce(d[b],function(a,b){return Number(a)+Number(b)},[])},d=function(a,b,c){var d=e(b,c),f=_.indexOf(c,a);return d[f]},e=function(a,b){var c=[];return _.reduce(b,function(b,d){var e=_.pick(d,a),f=Number(b)+Number(_.property(a)(e));return c.push(f),f},[]),c},f=function(a,b){var c={};return c[b]=_.pick(a,b),c},g=function(a){var b={};return b[a]=_.pluck(a.value,"field"),b},h=function(a,b,c,d,e){var f=a.key.field;return _.map(b,function(a){var b={};b[f]=e(c,a,d),c=_.extend(b,c)}),c},i=function(a){switch(a){case"sum":return c;case"rest":return d;default:return""}},j=function(a){return a.fields=b(a),_.map(a.formulas,function(b){var c=a.registers;a.registers=_.map(c,function(a){var d=i(b.type),e=g(b.group);return h(b.field,e,a,c,d)})}),a};return{calculate:j}}]),app.factory("ConvertService",["$filter","DataGrouperService",function(a,b){var c=function(a,b){var c={};return _.map(b,function(b){var d=_.pick(a,b.field);_.extend(c,d)}),c},d=function(a,b){var c=_.template(b),d=c(a);return d},e=function(b,c){c.filter&&(1==c.filter.length?b[c.field]=a(c.filter[0])(b[c.field]):2==c.filter.length?b[c.field]=a(c.filter[0])(b[c.field],c.filter[1]):3==c.filter.length&&(b[c.field]=a(c.filter[0])(b[c.field],c.filter[1],c.filter[2])))},f=function(a,b){return _.isArray(b.value)?_.map(b.value,function(b){e(a,b)}):e(a,b.value)},g=function(a,b){return f(a,b),{name:b.name,key:c(a,b.key),value:d(a,b.expression),order:b.order}},h=function(a,b){return registersFormat=angular.copy(a),_.map(b,function(a,b){return g(registersFormat,a)})},i=function(a,b){return g(a,b)},j=function(a,b){return h(a,b)};return{formatField:i,formatFields:j}}]),app.factory("FormatterService",["DataGrouperService",function(a){var b=function(a,b){var c={};return _.map(b,function(b){var d=_.pick(a,b.field);_.extend(c,d)}),c},c=function(a,b){var c=_.template(b),d=c(a);return d},d=function(a,b){return _.map(b.value,function(b,c){b.filter&&(2==b.filter.length?a[b.field]=$filter(b.filter[0])(a[b.field],b.filter[1]):3==b.filter.length&&(a[b.field]=$filter(b.filter[0])(a[b.field],b.filter[1],b.filter[2])))})},e=function(a,e){return d(a,e),{name:e.name,key:b(a,e.key),value:c(a,e.expression),order:e.order}},f=function(a,b){return registersFormat=angular.copy(a),_.map(b,function(a,b){return e(registersFormat,a)})},g=function(a,b){return e(a,b)},h=function(a,b){return f(a,b)};return{formatField:g,formatFields:h}}]),app.factory("DataGrouperService",function(){var a=function(a,b){return _.any(a,function(a){return _.isEqual(a,b)})},b=function(b,c){return _.reduce(b,function(b,d){var e=_.pick(d,c);return a(b,e)||b.push(e),b},[])},c=function(a,b,c){return _.map(_.where(a,b),function(a){return _.omit(a,c)})},d=function(a,d){var e=b(a,d);return _.map(e,function(b){var e=c(a,b,d);return{key:b,vals:e}})},e=function(a,b,c){if(c!=b.length){var f=d(a,b[c]);return _.map(f,function(a){var d=e(a.vals,b,c+1),f={key:a.key};return d?_.extend(f,{vals:d}):_.extend(f,{vals:a.vals}),f})}};return{group:function(a,b){return d(a,b)},keys:function(a,b){var c=d(a,b);return _.map(c,function(a){return a.key})},vals:function(a,b){var c=d(a,b);return _.map(c,function(a){return a.vals})},hierarchy:function(a,b){return e(a,b,0)}}}),app.factory("MessageService",["ngToast",function(a){return{success:function(b){a.success({content:'<i class="icon-check" style="margin-right:5px"></i> '+b,dismissOnTimeout:!0})},warning:function(b){a.warning(b)},info:function(b){a.info({content:'<i class="icon-info" style="margin-right:5px"></i> '+b,dismissOnTimeout:!0})},danger:function(b){a.danger({content:'<i class="icon-close" style="margin-right:5px"></i> '+b,dismissOnTimeout:!0})}}}]);